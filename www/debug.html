<script type="text/javascript">

var game;
var place;
var player;
var system;

require(
  [
    'vendor/vue', 'data', 'util', 'game', 'physics', 'resource', 'ship', 'system',
    'component/common',
    'component/card',
    'component/row',
  ],
  function(Vue, data, util, Game, Physics, Resource, Ship, sys) {
    game   = Game.game;
    place  = game.place();
    player = game.player;
    system = sys;

    const app = new Vue({
      el: '#test',
      data: {
        testDataSection: null,
        testData:        null,
        nominalDeltaV:   0.2,
        explainPrice:    '',
        explainPriceLoc: Game.game.locus,
      },
      computed: {
        turns:         function() { return game.turns },
        resources:     function() { return Object.keys(data.resources) },
        bodies:        function() { return Object.keys(data.bodies) },
        marketLoc:     function() { if (this.explainPriceLoc) return game.place(this.explainPriceLoc) },
        localNeed:     function() { if (this.explainPrice) return this.marketLoc.localNeed(this.explainPrice) },
        systemNeed:    function() { if (this.explainPrice) return game.systemNeed(this.explainPrice) },
        stock:         function() { if (this.explainPrice) return this.marketLoc.currentSupply(this.explainPrice) },
        supply:        function() { if (this.explainPrice) return this.marketLoc.supply(this.explainPrice) },
        demand:        function() { if (this.explainPrice) return this.marketLoc.demand(this.explainPrice) },
        basePrice:     function() { if (this.explainPrice) return this.marketLoc.calculatePrice(this.explainPrice) },
        scarcity:      function() { if (this.explainPrice) return this.marketLoc.scarcityMarkup(this.explainPrice) },
        underSupplied: function() { if (this.explainPrice) return this.marketLoc.is_under_supplied(this.explainPrice) },
        overSupplied:  function() { if (this.explainPrice) return this.marketLoc.is_over_supplied(this.explainPrice) },
        distanceMalus: function() { if (this.explainPrice) return this.marketLoc.distancePriceMalus(this.explainPrice) },
        adjustment:    function() { if (this.explainPrice) return this.marketLoc.adjustment(this.explainPrice) },
        nearestSource: function() { if (this.explainPrice) return this.marketLoc.nearestSource(this.explainPrice) },
        production:    function() { if (this.explainPrice) return this.marketLoc.production.get(this.explainPrice) },
        consumption:   function() { if (this.explainPrice) return this.marketLoc.consumption.get(this.explainPrice) },
        baseValue:     function() { if (this.explainPrice) return Resource.get(this.explainPrice).value },
      },
      methods: {
        gameTurns: function(turns) {
          let left = turns;
          let intvl;

          intvl = window.setInterval(() => {
            if (left > 0) {
              const batch = Math.min(5, left);
              left -= batch;
              game.turn(batch);
            }
            else {
              window.clearInterval(intvl);
              intvl = null;
              console.log(turns, 'turns complete');
            }
          }, 50);
        },

        shipRange: function(ship, maxDeltaV) {
          const dv = maxDeltaV ? (maxDeltaV * Physics.G) : ship.currentAcceleration();
          const bn = ship.maxBurnTime(dv) * data.hours_per_turn;
          const au = Physics.range(bn * 3600, 0, dv) / Physics.AU;
          return {
            mass:   util.R(ship.currentMass()),
            deltav: util.R(dv / Physics.G, 2),
            burn:   util.R(bn, 2),
            dist:   util.R(au, 2),
          };
        },

        shipMaxRanges: function() {
          this.testDataSection = 'shipMaxRanges';
          this.testData = {};

          for (const sc of Object.keys(data.shipclass)) {
            this.testData[sc] = {};
            const ship = new Ship({shipclass: sc, fuel: data.shipclass[sc].tank});
            this.testData[sc].nominal = this.shipRange(ship);
            ship.loadCargo('ore', ship.cargoSpace);
            this.testData[sc].loaded = this.shipRange(ship);
          }
        },

        shipRanges: function() {
          this.testDataSection = 'shipRanges';
          this.testData = {};

          for (const sc of Object.keys(data.shipclass)) {
            this.testData[sc] = {};
            const ship = new Ship({shipclass: sc, fuel: data.shipclass[sc].tank});
            this.testData[sc].nominal = this.shipRange(ship, this.nominalDeltaV);
            ship.loadCargo('ore', ship.cargoSpace);
            this.testData[sc].loaded = this.shipRange(ship, this.nominalDeltaV);
          }
        },
      },
      template: `
<card title="Testing">
  <btn @click="gameTurns(10)" block=1>10 turns</btn>
  <btn @click="gameTurns(50)" block=1>50 turns</btn>
  <btn @click="gameTurns(100)" block=1>100 turns</btn>
  <btn @click="gameTurns(500)" block=1>500 turns</btn>
  <btn @click="shipMaxRanges" block=1>Ship ranges at max delta-v</btn>
  <btn @click="shipRanges" block=1>Ship ranges at {{nominalDeltaV}} G</btn>

  <div class="my-3 input-group">
    <h4 class="mx-1">Price</h4>

    <select v-model="explainPriceLoc" class="form-control mx-1">
      <option value="">Location</option>
      <option v-for="body in bodies" :key="body" :value="body">{{body|caps}}</option>
    </select>

    <select v-model="explainPrice" class="form-control mx-1">
      <option value="">Resource</option>
      <option v-for="item in resources" :key="item" :value="item">{{item|caps}}</option>
    </select>
  </div>

  <table class="table" v-if="explainPrice">
    <tbody>
      <tr>
        <th>Price</th><td>{{basePrice|csn}}</td>
        <th>Base value</th><td>{{baseValue|csn}}</td>
      </tr>

      <tr>
        <th>Production</th><td>{{production|R(2)}}</td>
        <th>Consumption</th><td>{{consumption|R(2)}}</td>
      </tr>

      <tr>
        <th>Supply</th><td>{{supply|R(2)}}</td>
        <th>Demand</th><td>{{demand|R(2)}}</td>
      </tr>

      <tr>
        <th>Local need</th><td>{{localNeed|R(2)}}</td>
        <th>System need</th><td>{{systemNeed|R(2)}}</td>
      </tr>

      <tr>
        <th>Under supplied</th><td>{{underSupplied}}</td>
        <th>Over supplied</th><td>{{overSupplied}}</td>
      </tr>

      <tr>
        <th>Stock</th><td>{{stock}}</td>
        <th>Nearest source</th>
        <td v-if="nearestSource[0]">
          {{nearestSource[0]|caps}}
          ({{nearestSource[1]|AU|R(2)|unit('AU')}})
          <span v-if="distanceMalus">(malus {{distanceMalus|R(2)}})</span>
        </td>
      </tr>

      <tr>
        <th>Scarcity</th><td>{{scarcity|R(2)}}</td>
        <th>Adjustment</th><td>{{adjustment|R(2)}}</td>
      </tr>
    </tbody>
  </table>

  <card v-if="!explainPrice && testDataSection == 'shipMaxRanges'" title="Ship ranges (max G)" class="my-2">
    <card v-for="(data, sc) of this.testData" :key="sc" :title="sc|caps" class="my-2">
      <def y=0 split=2 term="Nominal" :def="data.nominal" />
      <def y=0 split=2 term="Loaded" :def="data.loaded" />
    </card>
  </card>

  <card v-if="!explainPrice && testDataSection == 'shipRanges'" :title="'Ship ranges (' + nominalDeltaV + 'G)'" class="my-2">
    <card v-for="(data, sc) of this.testData" :key="sc" :title="sc|caps" class="my-2">
      <def y=0 split=2 term="Nominal" :def="data.nominal" />
      <def y=0 split=2 term="Loaded" :def="data.loaded" />
    </card>
  </card>
</card>
      `,
    });
  }
);

</script>

<div id="test"></div>
