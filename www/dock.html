<div id="spacer-dockyard" class="panel panel-default">
  <div class="panel-heading">
    <h3 class="panel-title">Dockyard</h3>
  </div>
  <div class="panel-body">
    <p>
      There are endless warehouses along the docks. As you enter the approach
      the resource exchange, you are approached by several warehouse managers
      and sales people eager to do business with you.
    </p>
    <p>
      <button type="button" class="btn btn-default" id="spacer-dock-skip">Wait for it...</button>
    </p>
  </div>
</div>

<script type="text/javascript">

$(function() {
  let table;

  let refreshMarket = function() {
    if (table)
      table.root().remove();

    let player = game.player();
    let place  = game.place();
    let market = place.report();

    table = new Table(true);

    table.add_columns([
      'Resource',
      'Docks',
      'Ship',
      '<div style="text-align:right">Price</div>'
    ]);

    Object.keys(market).forEach((item) => {
      let ship  = player.inventory.get(item);
      let dock  = market[item].amount;
      let price = market[item].price;
      let max   = Math.min(Math.floor(game.player.money / price), dock);

      let row = [
        `<span class="text-capitalize">${item}</span>`,
        (dock > 0) ? `<a href="#" data-action="buy" data-max="${max}" data-count="${dock}" data-item="${item}">Buy <span class="badge">${dock}</span></a>`    : '',
        (ship > 0) ? `<a href="#" data-action="sell" data-max="${ship}" data-count="${ship}" data-item="${item}">Sell <span class="badge">${ship}</span></a>` : '',
        `<div style="text-align:right">${price}</div>`
      ];

      table.add_row(row);
    });

    table.attach('#spacer-dockyard');
    game.refresh();
  };

  $('#spacer-dockyard').on('click', 'tbody tr td a', (e) => {
    e.preventDefault();
    let button = $(e.currentTarget);
    let action = button.data('action');
    let item   = button.data('item');
    let count  = button.data('count');
    let max    = button.data('max');
    let form   = new InlineForm;
    let price  = game.place().price(item);

    let modal = new Modal(`${action} ${item}`, action, (e) => {
      let amount = form.get('amount');
      let money  = game.player().money;
      let ship   = game.player().inventory.get(item);
      let docks  = game.place().supply(item);
      let total  = amount * price;

      if (amount > 0) {
        // Buy
        if (action == 'buy') {
          if (amount > docks) {
            alert(`The requested amount (${amount}) is more than the local supply (${docks})!`);
            return;
          }

          if (money < total) {
            alert(`At a rate of ${price} each, ${amount} units of ${item} will cost ${total} credits, but you have only ${money}. I do not extend credit, friend.`);
            return;
          }

          game.player().money -= game.place().buy(item, amount);
          game.player().inventory.inc(item, amount);
        }
        // Sell
        else {
          if (amount > ship) {
            alert(`You do not have that many units of ${item} in your hold! Do you take me for a fool?`);
            return;
          }

          game.player().money += game.place().sell(item, amount);
          game.player().inventory.inc(item, -amount);
        }

        refreshMarket();
      }
    });

    form.add_input(new CounterField('amount', null, 1, max));
    form.attach(modal.body());
    modal.attach('#spacer-dockyard');
    modal.show();
  });

  let intvl;
  $('#spacer-dock-skip').click(function(e) {
    if (intvl) {
      window.clearInterval(intvl);
      intvl = null;
    }
    else {
      intvl = window.setInterval(() => {
        game.turn();
        refreshMarket();
      }, 1000);
    }
  });

  refreshMarket();
});

</script>
