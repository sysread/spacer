<script type="text/javascript">

$(function() {
  for (let body in data.bodies)
    $('#home').append(`<option value="${body}">${system.name(body)}</option>`);

  $('#home').change((e) => {
    let home = $('#home').val();
    $('#home-info').html( data.bodies[home].desc.split('|').map(t => {return `<p>${t}</p>`}).join('') );
    $('#home-info').html($('#' + home).html());
    $('#home-grav').text(data.bodies[home].gravity);
    $('#home-deltav').text(R(data.bodies[home].gravity * data.grav_deltav_factor, 3));

    let faction = data.bodies[home].faction;
    $('#faction').val(data.factions[faction].full_name);
    $('#faction-info').html($('#' + faction).html());
  });

  $('#home').val('mars');
  $('#home').change();

  $('#starting-game').on('shown.bs.modal', (e) => {
    $('#spacer-nav').data('in-transit', true);
    $('#starting-game-progress').css('width', '0%');

    let place   = $('#home').val();
    let faction = data.bodies[place].faction;
    let ship    = data.factions[faction].ship;

    let me = new Person({
      name    : $('#name').val(),
      home    : place,
      faction : faction,
      money   : 1000,
      ship    : new Ship({
        shipclass : ship,
        fuel      : data.shipclass[ship].tank
      })
    });

    me.ship.fuel = data.shipclass[ship].tank;
    game.new_game(me, place);

    let turns = data.initial_turns;
    let step  = Math.ceil(turns/10);
    let done  = 0;
    let timer;

    let interval = function() {
      if (done < turns) {
        let count = Math.min(turns - done, step);
        let pct = Math.ceil((done / turns) * 100);
        done += count;
        game.turn(count);
        $('#starting-game-progress').text(`${pct}%`).css('width', `${pct}%`);
        timer = window.setTimeout(interval, 200);
      }
      else {
        $('#starting-game-progress').css('width', '100%').text('Done!');
        game.refresh();
        $('#starting-game').modal('hide');
        $('#spacer-nav').data('in-transit', false);
        window.setTimeout(() => {open('summary')}, 100);
      }
    };

    timer = window.setTimeout(interval, 50);
  });
});

</script>

<div class="card p-3 mb-4">
  <h3 class="card-header">
    New Game
    <span class="float-right">
      <button id="start-game" type="button" class="btn btn-dark" data-toggle="modal" data-target="#starting-game">Start game</button>
    </span>
  </h3>
  <div class="card-body">
    <form>
      <label for="name">Captain name</label>
      <input class="form-control" type="text" name="name" id="name" value="Marco Solo">
      <br>

      <label for="home">Home</label>
      <select class="form-control text-capitalize" name="home" id="home"></select>
      <div class="form-text text-muted" id="home-info"></div>
      <div class="form-text text-muted">
        As a native growing up under <span id="home-grav"></span>G of
        gravity, your physiology can tolerate a maximum sustained acceleration
        of <span id="home-deltav"></span>G.
      </div>
      <br>

      <label for="faction">Faction</label>
      <input class="form-control" type="text" name="faction" id="faction" readonly>
      <div class="form-text text-muted" id="faction-info"></div>
      <br>
    </form>
  </div>
</div>

<div class="modal" id="starting-game" data-backdrop="static">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Starting game</h5>
      </div>
      <div class="modal-body">
        <div class="progress bg-dark">
          <div id="starting-game-progress" class="progress-bar bg-warning" style="height: 35px; width: 0%">0%</div>
        </div>
      </div>
    </div>
  </div>
</div>

<div hidden id="UN">
  <p>
    After the outbreak of hostilities with Mars more than 80 years ago and the
    treaties that followed, the UN assumed the role of the unified sovereign
    government over the Earth, Moon, and Mercury. Known for its glacial
    bureaucracy and stodgy leaders, Earth remains an economic powerhouse,
    largly as a result of remaining the sole inhabitable body in the system.
  </p>
  <p>
    Despite the fragile treaty after the War of Martian Independence, the UN
    member nations continue to see Mars as selfish and ungrateful.
  </p>
</div>

<div hidden id="MC">
  <p>
    Nearly 50 years after its founding as a science outpost in the early 22nd
    century, Mars declared independence from an Earth that it increasingly
    viewed as a distant, intrusive micromanager. In the 84 years since its
    founding, Mars has grown into a military power rivaling Earth, with a
    thriving economy and highly educated populace. Since its independence, Mars
    has focused its significant resources toward the scientific and
    technological achievements necessary to realize its population's dream of a
    "Green Mars".
  </p>
  <p>
    The Martian Commonwealth controls Mars and its moons as well as several of
    the Jovian moons, providing the infrastructure and resource to maintain and
    grow their subterranean and domed habitats, whose proximity to the radiant
    gas giant make them the bread basket of the outer planets.
  </p>
</div>

<div hidden id="TRANSA">
  <p>
    Those who live in the outer planets are exquisitely aware of the fragile
    existence they lead, completely dependent on shipments of food, water,
    medicine, and technology in order to survive.
  </p>
  <p>
    When Mars broke from Earth, deliveries to the furthest installations in the
    outer system ceased in the face of privateering and the realities of a war
    economy. Those who survived the food riots shortly found themselves under
    the unforgiving magnetic boot of the corporate security forces originally
    contracted to protect and police the scientific mission stationed on Pluto.
  </p>
  <p>
    Collectively calling themselves the Trans-Neptunian Authority, they quickly
    restored order and set to work building a strict, tightly controlled,
    society with the ultimate goal of achieving self-sufficiency.
  </p>
  <p>
    With resources stretched and hungry mouths to feed, TRANSA offers the
    lowest tax rate in the system, promising a hefty margin to any traders
    willing to make the "Long Haul", as it is popularly known. Given the size
    of TRANSA's tiny fleet and the vast volume of space it patrols, the Long
    Haul can as be perilous as it is profitable.
  </p>
</div>

<div hidden id="CC">
  <p>
    Holding a favorable position orbiting within the asteroid belt, the
    independent planetoid Ceres has long served as a trade hub between the
    inner and outer planets. Its location also serves to make it a launching
    point for mining operations within the asteroid belt.
  </p>
  <p>
    A number of shipyards have grown up around Ceres, taking advantage of the
    central location and ease of access to materials to make Ceres the primary
    ship-bulding center in the system.
  </p>
</div>

<div hidden id="UTC">
  <p>
    Faced with the same economic constraints and pressures as the outer planets
    during the war but with much closer and more powerful corporate interests
    at hand, the Saturnian moons controlling interests joined to form the
    United Trade Collective. Funded by some of the richest corporations on
    Earth, the UTC has become a force unto itself, patrolling the outer
    planets' trade routes with its corporate fleet.
  </p>
  <p>
    Life in the domes of Saturn is difficult, and the harvesting of ice and ore
    in the outer system is dangerous work, but citizen employees can rest
    assured that the Board of Directors has their best interests at heart, or
    at least their compound interest at heart, as many are bound by contract or
    debt to their Syndicate.
  </p>
</div>
