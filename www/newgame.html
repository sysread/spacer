<script type="text/javascript">

$(function() {
  const points = 5 * Object.keys(data.stats).length;
  let used = Object.keys(data.stats).length;

  $('#total-points').text(points);

  for (let body in data.bodies) $('#home').append(`<option value="${body}">${body}</option>`);
  $('#home').val('ganymede');

  for (let name of Object.keys(data.stats)) {
    let slider = new Slider({
      min      : 1,
      max      : 10,
      initial  : 1,
      callback : (value) => {
        $(`#stat-${name}`).val(value);
      },
      approve  : (change, value) => {
        let remaining = points - used;

        if (change > 0 && remaining < (change + value)) {
          change = remaining;
        }

        used += change;
        return change + value;
      }
    });

    let label = $(`<label class="text-capitalize" for="stat-${name}">${name}</label>`);
    let ctrl  = $(`<div class="id="slider-${name}">`);
    let stat  = $(`<input class="form-control form-control-sm" type="number" min="1" value="1" id="stat-${name}" readonly>`);
    let row   = $('<tr class="row">');

    let desc = data.stats[name].desc;
    let td = $('<td class="col-8">');

    td.append(ctrl.append(slider.group));
    if (desc) td.append(`<p class="form-text text-muted">${desc}</p>`);

    row.append($('<td class="col-2">').append(label));
    row.append(td);
    row.append($('<td class="col-2">').append(stat));

    $('#stats').append(row);
  }

  $('#starting-game').on('shown.bs.modal', (e) => {
    $('#starting-game-progress').css('width', '0%');

    let me = new Person({
      name     : $('#name').val(),
      money    : 1000,
      strength : parseInt($('#stat-strength').val(), 10),
      ship     : new Ship({
        name      : $('#ship').val(),
        shipclass : 'cutter'
      })
    });

    let place = $('#home').val();
    game.new_game(me, place);

    $('#starting-game-progress').css('width', '5%');
    let turns = data.initial_turns;
    let step  = Math.ceil(turns/5);
    let done  = 0;

    let intvl;
    intvl = window.setInterval(() => {
      if (done < turns) {
        let count = Math.min(turns - done, step);
        done += count;
        let pct = Math.max(5, Math.ceil((done / turns) * 100));
        $('#starting-game-progress').css('width', `${pct}%`);
        game.turn(count);
      }
      else {
        $('#starting-game-progress').css('width', '100%');
        window.clearInterval(intvl);
        $('#starting-game .modal-footer button').prop('disabled', false);
      }
    }, 5);
  });

  $('#starting-game').on('hidden.bs.modal', (e) => {
    game.refresh();
    open('summary');
  });
});

</script>

<div class="card p-3 mb-4">
  <h3 class="card-header">New Game</h3>
  <div class="card-body">
    <form>
      <label for="name">Captain name</label>
      <input class="form-control" type="text" name="name" id="name" value="Marco Solo">
      <br>

      <label for="name">Ship name</label>
      <input class="form-control" type="text" name="name" id="ship" value="The Boat">
      <br>

      <label for="home">Home</label>
      <select class="form-control text-capitalize" name="home" id="home"></select>
      <br>

      <label>Characteristics</label>
      <p>You have <span id="total-points"></span> points to distribute across your skills.</p>
      <table id="stats" class="table"></table>

      <div class="float-right">
        <button id="start-game" type="button" class="btn btn-dark" data-toggle="modal" data-target="#starting-game">Start playing</button>
      </div>
    </form>
  </div>
</div>

<div class="modal" id="starting-game" data-backdrop="static">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Starting game</h5>
      </div>
      <div class="modal-body">
        <div class="progress bg-dark">
          <div id="starting-game-progress" class="progress-bar bg-warning" style="height: 35px; width: 0%">
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-dark" data-dismiss="modal" disabled>Ok</button>
      </div>
    </div>
  </div>
</div>
