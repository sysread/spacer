<script type="text/javascript">

$(function() {
  let table = $('#exchange-table');
  let place = game.place();
  let slider;

  let update_table = function() {
    table.empty();

    for (let item of Object.keys(data.resources)) {
      let hold = game.player.ship.cargo.get(item);
      let dock = place.current_supply(item);
      let btn  = $(`<button type="button" class="btn btn-block text-capitalize">${item}</button>`);
      btn.attr({'data-toggle': 'modal', 'data-target': '#exchange-dialog'});
      btn.data('resource', item);

      if (dock === 0 && hold === 0) {
        btn.addClass('btn-secondary');
      }
      else {
        btn.addClass('btn-dark');
      }

      table.append(
        $('<div class="row">')
          .append( $('<div class="col col-sm-4 py-2">').append(btn) )
          .append(
            $('<div class="row col-12 col-sm-8 py-2">')
              .append($('<div class="col-3">Buy</div>'))
              .append($('<div class="col-3 mute">').append(csn(place.buy_price(item))))
              .append($('<div class="col-3">Sell</div>'))
              .append($('<div class="col-3 mute">').append(csn(place.sell_price(item))))
              .append($('<div class="col-3">Dock</div>'))
              .append($('<div class="col-3">').append(csn(dock)).addClass(dock > 0 ? 'b text-warning' : 'mute'))
              .append($('<div class="col-3">Ship</div>'))
              .append($('<div class="col-3">').append(csn(hold)).addClass(hold > 0 ? 'b text-warning' : 'mute'))))
    }
  };

  $('#exchange-dialog').on('show.bs.modal', function(e) {
    let item     = $(e.relatedTarget).data('resource');
    let tax_rate = place.sales_tax;
    let price    = place.price(item);
    let tax      = Math.ceil(price * tax_rate);
    let avail    = place.current_supply(item);
    let cargo    = game.player.ship.cargo.get(item);

    $('#exchange-resource').text(item);
    $('#exchange-tax-rate').text((Math.round(tax_rate * 10000) / 100) + '%');
    $('#exchange-price').val(price);
    $('#exchange-tax').val(tax);
    $('#exchange-docks').val(avail);
    $('#exchange-hold').val(cargo);
    $('#exchange-credits').val(game.player.money);

    let max = cargo + Math.min(avail, Math.floor(game.player.money / place.buy_price(item)), game.player.ship.cargo_left);

    slider = new Slider({
      step       : 1,
      min        : 0,
      max        : max,
      initial    : cargo,
      minmaxbtns : true,
      callback   : (amount) => {
        let diff = amount - game.player.ship.cargo.get(item);
        $('#exchange-docks').val(avail - diff);
        $('#exchange-hold').val(amount);
        if (diff > 0)
          $('#exchange-credits').val(game.player.money - (diff * (price + tax)));
        else
          $('#exchange-credits').val(game.player.money - (diff * price));
      }
    });

    $('#exchange-form').empty().append(slider.group);
  });

  $('#exchange-complete').click(function(e) {
    let item  = $('#exchange-resource').text();
    let count = slider.val - game.player.ship.cargo.get(item);

    if (count > 0) {
      game.player.debit(place.buy(item, count));
      game.player.ship.load_cargo(item, count);
    } else {
      game.player.credit(place.sell(item, -count));
      game.player.ship.unload_cargo(item, -count);
    }

    game.save_game();
    game.refresh();

    update_table();
    $('#exchange-dialog').modal('hide');
  });

  $('#market-dialog').on('show.bs.modal', function(e) {
    let item  = $('#exchange-resource').text();
    let price = game.place().buy_price(item);
    let tbody = $('#market-dialog tbody');
    tbody.empty();

    $('#market-data-resource').text(item);

    for (const body of Object.keys(data.bodies)) {
      let report = game.market(body);

      if (report === null)
        continue;

      let name = `${body} <span class="badge badge-pill float-right">${system.kind(body)}</span>`;
      let info = report.data[item];

      let row = $('<tr>');
      row.append(`<td class="text-capitalize">${system.name(body)}</td>`);
      row.append( $(`<td class="text-right">${csn(info.buy)}</td>`).addClass(game.place().sell_price(item) > info.buy ? 'text-warning' : '') );
      row.append( $(`<td class="text-right">${csn(info.sell)}</td>`).addClass(price < info.sell ? 'text-warning' : '') );
      row.append(`<td class="text-right">${info.stock || ''}</td>`);
      row.append(`<td class="text-right">${report.age}</td>`);

      if (body === game.locus) {
        row.addClass('border');
      }

      $('#market-dialog tbody').append(row);
    }
  });

  update_table();
});

</script>

<div class="card">
  <h3 class="card-header">Commerce</h3>
  <div class="card-body">
    <div class="card-text">
      <p>
        There are endless warehouses along the docks. As you approach the
        resource exchange, you are approached by several warehouse managers
        and sales people eager to do business with you.
      </p>
      <div id="exchange-table" class="container container-fluid"></div>
    </div>
  </div>
</div>

<div class="modal" id="exchange-dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Exchange of <span id="exchange-resource"></span></h5>
        <button type="button" class="btn btn-secondary float-right" data-toggle="modal" data-target="#market-dialog">Report</button>
      </div>
      <div class="modal-body">
        <table class="table">
          <tbody>
            <tr><th scope="row">Price</th><td><input class="form-control" readonly type="number" id="exchange-price"></td></tr>
            <tr><th scope="row">Sales tax <span id="exchange-tax-rate" class="badge badge-pill"></span></th><td><input class="form-control" readonly type="number" id="exchange-tax"></td></tr>
            <tr><th scope="row">Market</th><td><input class="form-control" readonly type="number" id="exchange-docks"></td></tr>
            <tr><th scope="row">Hold</th><td><input class="form-control" readonly type="number" id="exchange-hold"></td></tr>
            <tr><th scope="row">Credits</th><td><input class="form-control" readonly type="number" id="exchange-credits"></td></tr>
          </tbody>
        </table>
        <div id="exchange-form"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-dark" id="exchange-complete">Complete Transaction</button>
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
      </div>
    </div>
  </div>
</div>

<div class="modal" id="market-dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">System market report for <span id="market-data-resource"></span></h5>
      </div>
      <div class="modal-body">
        <table class="table table-sm">
          <thead>
            <tr>
              <th>Market</th>
              <th class="text-right">Buy</th>
              <th class="text-right">Sell</th>
              <th class="text-right">Stock</th>
              <th class="text-right" title="Light speed time delay of market data in hours">Age</th>
            </tr>
          </thead>
          <tbody>
          </tbody>
        </table>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-dark" data-dismiss="modal">Ok</button>
      </div>
    </div>
  </div>
</div>
