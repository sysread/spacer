<script type="text/javascript">

$(function() {
  let table = $('#exchange-table tbody');
  let place = game.place();
  let slider;

  let update_table = function() {
    table.empty();

    for (let item of Object.keys(data.resources)) {
      let cargo = game.player.ship.cargo.get(item);
      let avail = place.current_supply(item);
      let price = place.price(item);
      let btn   = $(`<button type="button" class="btn btn-block btn-sm btn-dark text-capitalize" data-toggle="modal" data-target="#exchange-dialog">${item}</button>`);

      btn.data('resource', item);

      if (cargo === 0 || avail === 0)
        btn.addClass('btn-secondary');

      table
        .append($('<tr>')
          .append($('<td>').append(btn))
          .append(`<td class="text-right">${avail || '&nbsp;'}</td>`)
          .append(`<td class="text-right">${csn(place.buy_price(item))}</td>`)
          .append(`<td class="text-right">${cargo || '&nbsp;'}</td>`)
          .append(`<td class="text-right">${csn(place.sell_price(item))}</td>`));
    }
  };

  $('#exchange-dialog').on('show.bs.modal', function(e) {
    let item     = $(e.relatedTarget).data('resource');
    let tax_rate = place.sales_tax;
    let price    = place.price(item);
    let tax      = Math.ceil(price * tax_rate);
    let avail    = place.current_supply(item);
    let cargo    = game.player.ship.cargo.get(item);

    $('#exchange-resource').text(item);
    $('#exchange-tax-rate').text((tax_rate * 100) + '%');
    $('#exchange-price').val(price);
    $('#exchange-tax').val(tax);
    $('#exchange-docks').val(avail);
    $('#exchange-hold').val(cargo);
    $('#exchange-credits').val(game.player.money);

    let max = cargo + Math.min(avail, Math.floor(game.player.money / place.buy_price(item)), game.player.ship.cargo_left);

    slider = new Slider({
      step       : 1,
      min        : 0,
      max        : max,
      initial    : cargo,
      minmaxbtns : true,
      callback   : (amount) => {
        let diff = amount - game.player.ship.cargo.get(item);
        $('#exchange-docks').val(avail - diff);
        $('#exchange-hold').val(amount);
        if (diff > 0)
          $('#exchange-credits').val(game.player.money - (diff * (price + tax)));
        else
          $('#exchange-credits').val(game.player.money - (diff * price));
      }
    });

    $('#exchange-form').empty().append(slider.group);
  });

  $('#exchange-complete').click(function(e) {
    let item  = $('#exchange-resource').text();
    let count = slider.val - game.player.ship.cargo.get(item);

    if (count > 0) {
      game.player.debit(place.buy(item, count));
      game.player.ship.load_cargo(item, count);
    } else {
      game.player.credit(place.sell(item, -count));
      game.player.ship.unload_cargo(item, -count);
    }

    game.save_game();
    game.refresh();

    update_table();
    $('#exchange-dialog').modal('hide');
  });

  $('#market-dialog').on('show.bs.modal', function(e) {
    let item  = $('#exchange-resource').text();
    let tbody = $('#market-dialog tbody');
    tbody.empty();

    $('#market-data-resource').text(item);

    for (const body of Object.keys(data.bodies)) {
      let report = game.market(body);

      if (report === null)
        continue;

      let name  = `${body} <span class="badge badge-pill float-right">${system.kind(body)}</span>`;
      let info  = report.data[item];
      let trend = info.trend > 0 ? `+${info.trend}` : (info.trend || '');

      let row = $('<tr>');
      if (body === game.locus) row.addClass('bg-dark');
      row.append(`<td class="text-capitalize">${name}</td>`);
      row.append(`<td class="text-right">${info.buy}</td>`);
      row.append(`<td class="text-right">${info.sell}</td>`);
      row.append(`<td class="text-right">${info.stock || ''}</td>`);
      row.append(`<td class="text-right">${trend}</td>`);
      row.append(`<td class="text-right">${report.age}</td>`);
      $('#market-dialog tbody').append(row);
    }
  });

  update_table();
});

</script>

<div class="card p-3">
  <h3 class="card-header">Commerce</h3>
  <div class="card-body">
    <div class="card-text">
      <p>
        There are endless warehouses along the docks. As you approach the
        resource exchange, you are approached by several warehouse managers
        and sales people eager to do business with you.
      </p>
      <table class="table table-sm" id="exchange-table">
        <thead>
          <tr>
            <th>Resource</th>
            <th class="text-right">Docks</th>
            <th class="text-right">Buy</th>
            <th class="text-right">Ship</th>
            <th class="text-right">Sell</th>
          </tr>
        </thead>
        <tbody>
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="modal" id="exchange-dialog" data-backdrop="static">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Exchange of <span id="exchange-resource"></span></h5>
      </div>
      <div class="modal-body">
        <table class="table">
          <tbody>
            <tr><th scope="row">Price</th><td><input class="form-control" disabled type="number" id="exchange-price"></td></tr>
            <tr><th scope="row">Sales tax <span id="exchange-tax-rate" class="badge badge-pill"></span></th><td><input class="form-control" disabled type="number" id="exchange-tax"></td></tr>
            <tr><th scope="row">Docks</th><td><input class="form-control" disabled type="number" id="exchange-docks"></td></tr>
            <tr><th scope="row">Hold</th><td><input class="form-control" disabled type="number" id="exchange-hold"></td></tr>
            <tr><th scope="row">Credits</th><td><input class="form-control" disabled type="number" id="exchange-credits"></td></tr>
          </tbody>
        </table>
        <div id="exchange-form"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-sm btn-dark" id="exchange-complete">Complete transaction</button>
        <button type="button" class="btn btn-sm btn-secondary" data-toggle="modal" data-target="#market-dialog">Market data</button>
        <button type="button" class="btn btn-sm btn-secondary" data-dismiss="modal">Cancel</button>
      </div>
    </div>
  </div>
</div>

<div class="modal" id="market-dialog" data-backdrop="static">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">System market report for <span id="market-data-resource"></span></h5>
      </div>
      <div class="modal-body">
        <table class="table table-sm">
          <thead>
            <tr>
              <th>Market</th>
              <th class="text-right">Buy</th>
              <th class="text-right">Sell</th>
              <th class="text-right">Stock</th>
              <th class="text-right">Trend</th>
              <th class="text-right" title="Light speed time delay of market data in hours">Age</th>
            </tr>
          </thead>
          <tbody>
          </tbody>
        </table>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-sm btn-dark" data-dismiss="modal">Ok</button>
      </div>
    </div>
  </div>
</div>
