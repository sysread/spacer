<script type="text/javascript">

$(function() {
  let table  = $('#exchange-table tbody');
  let player = game.player();
  let place  = game.place();
  let slider;

  let update_table = function() {
    table.empty();

    for (let item of Object.keys(data.resources)) {
      let cargo = player.ship.cargo.get(item);
      let avail = place.supply(item);
      let price = place.price(item);
      let btn   = $(`<button type="button" class="btn btn-block btn-sm btn-dark text-capitalize" data-toggle="modal" data-target="#exchange-dialog">${item}</button>`);

      if (cargo > 0 || avail > 0)
        btn.data('resource', item);
      else
        btn.addClass('btn-secondary').prop('disabled', true);

      table
        .append($('<tr>')
          .append($('<td>').append(btn))
          .append(`<td class="text-right">${avail || '&nbsp;'}</td>`)
          .append(`<td class="text-right">${cargo || '&nbsp;'}</td>`)
          .append(`<td class="text-right">${csn(price)}</td>`));
    }
  };

  $('#exchange-dialog').on('show.bs.modal', function(e) {
    let item  = $(e.relatedTarget).data('resource');
    let price = place.price(item);
    let avail = place.supply(item);
    let cargo = player.ship.cargo.get(item);

    $('#exchange-resource').text(item);
    $('#exchange-price').val(price);
    $('#exchange-docks').val(avail);
    $('#exchange-hold').val(cargo);
    $('#exchange-credits').val(player.money);

    let max = cargo + Math.min(avail, Math.floor(player.money / price), player.ship.cargo_left);

    slider = new Slider({
      step       : 1,
      min        : 0,
      max        : max,
      initial    : cargo,
      minmaxbtns : true,
      callback   : (amount) => {
        let diff = amount - player.ship.cargo.get(item);
        $('#exchange-docks').val(avail - diff);
        $('#exchange-hold').val(amount);
        $('#exchange-credits').val(player.money - (diff * price));
      }
    });

    $('#exchange-form').empty().append(slider.group);
  });

  $('#exchange-complete').click(function(e) {
    let item  = $('#exchange-resource').text();
    let count = slider.val - player.ship.cargo.get(item);

    if (count > 0) {
      player.money -= place.buy(item, count);
      player.ship.load_cargo(item, count);
    } else {
      player.money += place.sell(item, -count);
      player.ship.unload_cargo(item, -count);
    }

    game.refresh();
    update_table();
    $('#exchange-dialog').modal('hide');
  });

  update_table();
});

</script>

<div class="card p-3">
  <h3 class="card-header">Commerce</h3>
  <div class="card-body">
    <div class="card-text">
      <p>
        There are endless warehouses along the docks. As you approach the
        resource exchange, you are approached by several warehouse managers
        and sales people eager to do business with you.
      </p>
      <table class="table table-sm" id="exchange-table">
        <thead>
          <tr>
            <th>Resource</th>
            <th class="text-right">Docks</th>
            <th class="text-right">Ship</th>
            <th class="text-right">Price</th>
          </tr>
        </thead>
        <tbody>
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="modal" id="exchange-dialog" data-backdrop="static">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Exchange of <span id="exchange-resource"></span></h5>
      </div>
      <div class="modal-body">
        <table class="table">
          <tbody>
            <tr><th scope="row">Price</th><td><input class="form-control" disabled type="number" id="exchange-price"></td></tr>
            <tr><th scope="row">Docks</th><td><input class="form-control" disabled type="number" id="exchange-docks"></td></tr>
            <tr><th scope="row">Hold</th><td><input class="form-control" disabled type="number" id="exchange-hold"></td></tr>
            <tr><th scope="row">Credits</th><td><input class="form-control" disabled type="number" id="exchange-credits"></td></tr>
          </tbody>
        </table>
        <div id="exchange-form"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-sm btn-dark" id="exchange-complete">Complete transaction</button>
        <button type="button" class="btn btn-sm btn-secondary" data-dismiss="modal" id="exchange-cancel">Cancel</button>
      </div>
    </div>
  </div>
</div>
