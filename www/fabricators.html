<script type="text/javascript">

$(function() {
  let fee_pct = data.craft_fee;
  let player  = game.player;
  let table   = $('#recipe-table tbody');

  let update_recipes = function() {
    let container = new Container;

    let info = new Card;
    info.set_header('Fabricators');
    info.add_text('A triumph of cybernetics, the fabricators are able to manufacture nearly anything, given the necessary materials and plans... and a small fee, of course.');
    info.add_text(`${game.place().fabricationAvailability()}% of fabricator capacity is available at this time.`);
    container.add(info.card);

    for (let item of Object.keys(data.resources)) {
      let recipe = data.resources[item].recipe;

      if (recipe) {
        let val   = game.place().price(item);
        let fee   = Math.max(1, Math.round(fee_pct * val));
        let amt   = Math.min(Math.floor(player.money / fee), player.canCraft(item));
        let turns = game.place().fabricationTime(item);

        let card = new Card;
        card.set_header(item).addClass('text-capitalize');
        card.add_text(`You have the resources to fabricate ${amt} of this item.`);

        if (amt > 0) {
          let btn = card.add_header_button(`${csn(fee)}c`).attr({'data-toggle': 'modal', 'data-target': '#craft-dialog'});

          btn.data({
            item      : item,
            fee       : fee,
            amt       : amt,
            turns     : turns,
            materials : recipe.materials
          });
        }

        let mats = $('<div class="row">');

        card.add(
          $('<div class="row">')
            .append(
              $('<div class="row col-12 py-2">')
                .append($('<div class="col-6 col-sm-3">Value</div>'))
                .append($('<div class="col-6 col-sm-3 mute">').append(csn(val) + 'c'))
                .append($('<div class="col-6 col-sm-3">Turns</div>'))
                .append($('<div class="col-6 col-sm-3 mute">').append(turns))
                .append($('<div class="col-6 col-sm-3">Materials</div>'))
                .append($('<div class="col-6 col-sm-9 mute">').append(mats))));


        for (let m of Object.keys(recipe.materials)) {
          mats.append( $('<div class="col-sm-4">').append(`(${recipe.materials[m]}) ${m}`) );
        }

        container.add(card.root);
      }
    }

    $('#fabrication').empty().append(container.root);
  };

  $('#craft-dialog').on('show.bs.modal', function(e) {
    let btn = $(e.relatedTarget);

    $('#craft-slider').empty();
    $('#craft-resource').text(btn.data('item'));
    $('#craft-complete').data(btn.data());
    $('#craft-amount').val(1);

    if (btn.data('amt') > 1) {
      let slider = new Slider({
        min      : 1,
        max      : btn.data('amt'),
        step     : 1,
        initial  : 1,
        callback : (n) => {$('#craft-amount').val(n)}
      });

      $('#craft-slider').append(slider.group);
    }
  });

  $('#craft-complete').click(function(e) {
    let data     = $(this).data();
    let resource = data.item;
    let recipe   = data.materials;
    let amt      = parseInt($('#craft-amount').val(), 10);

    if (recipe) {
      for (let i = 0; i < amt; ++i) {
        player.debit(data.fee);

        for (let mat of Object.keys(recipe))
          player.ship.unloadCargo(mat, recipe[mat]);

        game.turn(data.turns);
        player.ship.loadCargo(resource, 1);
        game.refresh();
      }
    }

    game.save_game();
    update_recipes();
    $('#craft-dialog').modal('hide');

    let msg = new Ok(`${amt} unit(s) of ${resource} has been placed in your ship's hold.`);
    msg.show();
  });

  update_recipes();
});

</script>

<div id="fabrication"></div>

<div class="modal" id="craft-dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Fabricate <span class="text-capitalize" id="craft-resource"></span></h5>
      </div>
      <div class="modal-body">
        <div class="row p-2">
          <div class="col"><label for="craft-amount">Units</label></div>
          <div class="col"><input type="number" class="form-control" id="craft-amount" readonly></div>
        </div>
        <div class="row p-2">
          <div class="col" id="craft-slider"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-dark" id="craft-complete">Push the big red button</button>
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
      </div>
    </div>
  </div>
</div>
