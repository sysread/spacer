<script type="text/javascript">

$(function() {
  let fee_pct = 0.005;
  let player  = game.player();
  let table   = $('#recipe-table tbody');

  let update_recipes = function() {
    table.empty();

    for (let item of Object.keys(data.resources)) {
      let recipe = data.resources[item].recipe;
      let value  = game.place().price(item);

      if (recipe) {
        let btn = $(`<button type="button" class="btn btn-block btn-sm text-capitalize">${item}</button>`);
        let fee = Math.max(1, Math.round(fee_pct * value));

        let mats = $('<div>');
        for (let material of Object.keys(recipe.materials))
          mats.append(`<div class="text-capitalize">${material}: ${recipe.materials[material]}</div>`);

        if (player.can_craft(item) && player.money >= fee) {
          btn.addClass('btn-light').click(function(e) {
            $('#craft-resource').text(item);
            $('#craft-message').empty()
              .append(`<p>Fabrication of one unit of ${item} takes ${recipe.tics} turn(s) and costs ${fee} credit(s).</p>`)
              .append('<p>The following materials from your inventory will be used:</p>')
              .append($(mats).clone());
            $('#craft-dialog').modal('show');
          });
        }
        else {
          btn.addClass('btn-secondary').prop('disabled', true);
        }

        table.append($('<tr>')
          .append($('<td>').append(btn))
          .append($(`<td class="text-right">${csn(value)}</td>`))
          .append($(`<td class="text-right">${recipe.tics}</td>`))
          .append($(`<td class="text-right">${csn(fee)}</td>`))
          .append($(`<td class="text-right">`).append(mats)));
      }
    }
  }

  $('#craft-complete').click(function(e) {
    let resource = $('#craft-resource').text();
    let recipe   = data.resources[resource].recipe;

    if (recipe) {
      let value = game.place().price(resource);
      player.money -= Math.max(1, Math.round(fee_pct * value));

      for (let mat of Object.keys(recipe.materials)) {
        player.inventory.dec(mat, recipe.materials[mat]);
      }

      for (var i = 0; i < recipe.tics; ++i)
        game.turn();

      player.inventory.inc(resource, 1);
    }

    update_recipes();
    $('#craft-dialog').modal('hide');
    message(`1 unit of ${resource} has been placed in your ship's hold.`, 'info', true);
  });

  update_recipes();
});

</script>

<div class="card p-3">
  <h3 class="card-header">Fabricators</h3>
  <div class="card-body">
    <div class="card-text">
      <p>
        A triumph of cybernetics, the fabricators are able to manufacture
        nearly anything, given the necessary materials and plans... and a small
        fee, of course.
      </p>
      <table class="table table-sm" id="recipe-table">
        <thead>
          <tr>
            <th>Resource</th>
            <th class="text-right">Market value</th>
            <th class="text-right">Turns</th>
            <th class="text-right">Fee</th>
            <th class="text-right">Materials</th>
          </tr>
        </thead>
        <tbody>
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="modal" id="craft-dialog" data-backdrop="static">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Fabricate <span id="craft-resource"></span></h5>
      </div>
      <div class="modal-body">
        <div id="craft-message"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-light" id="craft-complete">Push the big red button</button>
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
      </div>
    </div>
  </div>
</div>
