<script type="text/javascript">

$(() => {
  let ship    = game.player.ship;
  let navcomp = new NavComp(game.player.maxAcceleration(), ship, game.place().name);

  $('#nav-player-home' ).text(data.bodies[game.player.home].name);
  $('#nav-player-g'    ).text(data.bodies[game.player.home].gravity);
  $('#nav-player-max-g').text(game.player.maxAcceleration().toFixed(2));
  $('#nav-ship-g'      ).text(game.player.shipAcceleration().toFixed(2));
  $('#nav-ship-t'      ).text(csn(Math.round(game.player.ship.currentMass())));
  $('#nav-ship-fuel'   ).text(Math.round(game.player.ship.fuel * 100) / 100);
  $('#nav-ship-burn'   ).text(game.player.ship.maxBurnTime() * data.hours_per_turn);

  let nav = $('<div>');

  for (let body of system.bodies()) {
    if (body != game.place().name) {
      let name = system.short_name(body);
      let kind = system.kind(body);
      let best = navcomp.fastest(body);

      let btn, dist, acc, time, turns, burn;

      if (best !== undefined) {
        let plan = best.transit;
        burn  = best.burn;
        turns = plan.turns;
        acc   = plan.accel.toFixed(2);
        dist  = plan.au.toFixed(2) || '< 0.01';
        time  = csn(plan.hours);

        btn = $(`<button data-toggle="modal" data-target="#nav-dialog" type="button" class="btn btn-dark btn-block">`);
        btn.append(`<span class="float-left">${name}</span>`);

        if (kind !== 'Planet')
          btn.append(`<span class="badge badge-pill float-right">${kind}</span>`);

        btn.data({selected: best});

        acc += ' G';
      }
      else {
        dist = '<span class="badge badge-pill">Out of range</span>';
        acc  = '';
        time = '';

        btn = $(`<button type="button" class="btn btn-sm btn-dark btn-block disabled">`);
        btn.append(`<span class="float-left">${name}</span>`);
        btn.append(`<span class="badge badge-pill float-right">${system.kind(body)}</span>`);
      }

      nav.append(
        $('<div class="row">')
          .append( $('<div class="col col-sm-6 py-2">').append(btn) )
          .append(
            $('<div class="row col-12 col-sm-6 py-2">')
              .append($('<div class="col-6 mute">').append(dist + ' AU'))
              .append($('<div class="col-6 mute">').append(time + ' hours'))));
    }
  }

  $('#navcomp').append(nav);

  $('#nav-dialog').on('show.bs.modal', function(e) {
    let best    = $(e.relatedTarget).data('selected');
    let plan    = best.transit;
    let rate    = $(e.relatedTarget).data('burnRate');
    let target  = system.name(plan.dest);
    let type    = system.kind(plan.dest);
    let size    = game.place(plan.dest).size;
    let traits  = uniq(game.place(plan.dest).traits, ', ');
    let faction = data.factions[game.place(plan.dest).faction].full_name;
    let [days, hours] = plan.days_hours;

    let slider = new Slider({
      min        : 0,
      max        : navcomp.transits[plan.dest].length - 1,
      step       : 3,
      initial    : best.index,
      minmaxbtns : true,
      callback   : (n) => {
        let transit = navcomp.transits[plan.dest][n];
        plan = transit.transit;
        [days, hours] = plan.days_hours;

        $('#nav-transit').data('plan', plan);
        $('#nav-transit').data('burnRate', rate);

        $('#nav-accel').text(plan.accel.toFixed(2));
        $('#nav-flip').text(csn(plan.hours/2));
        $('#nav-distance-au').text(plan.au.toFixed(1));
        $('#nav-distance-km').text(csn(plan.km.toFixed(0)));
        $('#nav-deltav').text(plan.accel.toFixed(2));
        $('#nav-fuel').text((Math.round(transit.fuel * 100) / 100) + ' tonnes (est)');
        $('#nav-time').text(`${csn(days)} days, ${csn(hours)} hours (${plan.turns} turns)`);
      }
    });

    $('#nav-adjust').empty().append(slider.group);

    let notes = $('<ul>')
      .append(`<li>${faction} member</li>`)
      .append(`<li>${type}</li>`)
      .append(`<li>${size} economy</li>`);

    if (traits) notes.append(`<li>${traits}</li>`);

    $('#nav-destination').empty().append(`${target}`).append(notes);

    $('#nav-transit-dest').text(target);
  });

  $('#nav-transit').on('shown.bs.modal', () => {
    $('#spacer-nav').data('in-transit', true);

    let plan = $('#nav-transit').data('plan');
    let rate = $('#nav-transit').data('burnRate');
    let timer;

    let interval = function() {
      if (plan.left > 0) {
        $('#nav-transit-progress').finish();

        let count = Math.min(plan.left, Math.floor(plan.turns / 10));

        for (let i = 0; i < count; ++i) {
          game.player.ship.burn(plan.accel);
          plan.turn();
        }

        let d = plan.dist_left.toFixed(2);
        let p = Math.round(plan.pct_complete);

        $('#nav-transit-distance').text(`${d} AU`);
        $('#nav-transit-progress').css('width', `${p}%`);

        game.turn(count);
        timer = window.setTimeout(interval, 200);
      }
      else {
        $('#nav-transit').modal('hide');
        $('#spacer-nav').data('in-transit', false);
        game.transit(plan.dest);
        open('summary');
      }
    };

    timer = window.setTimeout(interval, 50);
  });

  $('#nav-system-map').on('click', (e)=>{open('plot')});
});

</script>

<div class="card p-3">
  <h3 class="card-header">
    Navigation
    <button type="button" class="btn btn-dark float-right" id="nav-system-map">Map</button>
  </h3>
  <div class="card-body">
    <div class="card-text">
      <p>
        Your navigational computer automatically calculates the optimal
        trajectory from your current location to the other settlements in the
        system.
      </p>
      <p>
        Being born on <span id="nav-player-home"></span>, your body is adapted
        to <span id="nav-player-g"></span>G, allowing you to endure a sustained
        burn at <span id="nav-player-max-g"></span>G.
      </p>
      <p>
        Your ship is capable of <span id="nav-ship-g"></span>Gs of acceleration
        with her current load out (<span id="nav-ship-t"></span> metric
        tonnes). With <span id="nav-ship-fuel"></span> tonnes of fuel, your
        ship has a maximum burn time of <span id="nav-ship-burn"></span> hours
        at maximum thrust.
      </p>
      <div id="navcomp"></div>
    </div>
  </div>
</div>

<div class="modal" id="nav-dialog" data-backdrop="static">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Flight plan</h5>
      </div>
      <div class="modal-body">
        <p>
          At <span id="nav-accel"></span>G, your ship will flip after
          <span id="nav-flip"></span> hours of acceleration and begin
          its deceleration burn.
        </p>
        <div id="nav-adjust"></div>
        <table class="table">
          <tbody>
            <tr><th scope="row">AU</th><td id="nav-distance-au"></td></tr>
            <tr><th scope="row">km</th><td id="nav-distance-km"></td></tr>
            <tr><th scope="row">Acceleration</th><td><span id="nav-deltav"></span> G</td></tr>
            <tr><th scope="row">Fuel usage</th><td id="nav-fuel"></td></tr>
            <tr><th scope="row">Total time</th><td id="nav-time"></td></tr>
            <tr><th scope="row">Destination</th><td id="nav-destination"></td></tr>
          </tbody>
        </table>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-dark" data-dismiss="modal" id="nav-complete" data-toggle="modal" data-target="#nav-transit">Engage</button>
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
      </div>
    </div>
  </div>
</div>

<div class="modal" id="nav-transit" data-backdrop="static">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">En route to <span class="text-capitalize" id="nav-transit-dest"></span></h5>
      </div>
      <div class="modal-body">
        <div class="progress bg-dark">
          <div id="nav-transit-progress" class="progress-bar bg-warning" style="height: 35px">
            <span id="nav-transit-distance" class="badge badge-pill badge-dark float-left m-1 font-weight-normal" style="font-size:14px"></span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
