<script type="text/javascript">

$(function() {
  let table = $('#navcomp-table tbody');
  let max_a = Math.min(game.player().max_acceleration(), game.player().ship_acceleration());

  for (let body of system.bodies().sort()) {
    if (body != game.place().name) {
      let name  = system.name(body);
      let plan  = system.astrogate(game.place().name, body, max_a);

      if (plan !== null) {
        let hrs, dist, unit, acc, turns;
        hrs   = csn(Math.ceil(plan.time));
        turns = Math.ceil(hrs/4);
        acc   = Math.max(0.01, plan.accel.toFixed(2));

        if (plan.dist < system.AU) {
          dist = csn(Math.ceil(plan.dist/1000));
          unit = 'km';
        }
        else {
          dist = (plan.dist/system.AU).toFixed(1);
          unit = 'AU';
        }

        let btn = $(`<button data-toggle="modal" data-target="#nav-dialog" type="button" class="btn btn-sm btn-dark btn-block">${name}</button>`);

        btn.data({
          destination : [body, name],
          accel       : acc,
          distance    : [plan.dist, dist, unit],
          time        : [plan.time, hrs, turns]
        });

        table
          .append($('<tr>')
            .append($('<td>').append(btn))
            .append(`<td>${system.kind(body)}</td>`)
            .append(`<td class="text-right">${dist} ${unit}</td>`)
            .append(`<td class="text-right">${acc}G</td>`)
            .append(`<td class="text-right">${hrs} hrs</td>`)
            .append(`<td class="text-right">${turns}</td>`));
      }
      else {
        table
          .append($('<tr>')
            .append(`<td>${name}</td>`)
            .append(`<td>${system.kind(body)}</td>`)
            .append(`<td class="text-right">N/A</td>`)
            .append(`<td class="text-right">N/A</td>`)
            .append(`<td class="text-right">&gt; 1 year</td>`)
            .append(`<td class="text-right"></td>`));
      }
    }
  }

  $('#nav-dialog').on('show.bs.modal', function(e) {
    let btn   = $(e.relatedTarget);
    let dest  = btn.data('destination');
    let dist  = btn.data('distance');
    let time  = btn.data('time');
    let accel = btn.data('accel');
    $('#nav-accel').text(accel);
    $('#nav-destination').text(dest[1]);
    $('#nav-distance').text(`${dist[1]} ${dist[2]}`);
    $('#nav-time').text(`${time[1]} hours (${time[2]} turns)`);

    $('#nav-complete').off('click').on('click', function(e) {
      $('#nav-dialog').off('hide.bs.modal').on('hide.bs.modal', () => {
        for (var i = 0; i < time[2]; ++i) game.turn();
        game.transit(dest[0]);
        open('summary');
      });
    });
  });

  $('#nav-player-str').text(game.player().strength);
  $('#nav-player-g'  ).text(game.player().max_acceleration().toFixed(2));
  $('#nav-ship-g'    ).text(game.player().ship_acceleration().toFixed(2));
});

</script>

<div class="card p-3">
  <h3 class="card-header">Navigation computer</h3>
  <div class="card-body">
    <div class="card-text">
      <p>
        Your navigational computer automatically calculates the optimal
        trajectory from your current location to the other settlements in the
        system.
      </p>
      <p>
        With a strength of <span id="nav-player-str"></span>, you are able to endure a
        sustained <span id="nav-player-g"></span>G burn. Your ship is capable
        of <span id="nav-ship-g"></span>Gs of acceleration with her current
        load out.
      </p>
      <table class="table table-sm" id="navcomp-table">
        <thead>
          <tr>
            <th>Destination</th>
            <th>Type</th>
            <th class="text-right">Dist.</th>
            <th class="text-right">Accel.</th>
            <th class="text-right">Time</th>
            <th class="text-right">Turns</th>
          </tr>
        </thead>
        <tbody>
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="modal" id="nav-dialog" data-backdrop="static">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Flight plan</h5>
      </div>
      <div class="modal-body">
        <p>
          Accelerating at <span id="nav-accel"></span>G, your
          ship will flip at the midway point and begin its deceleration burn.
        </p>
        <table class="table">
          <tbody>
            <tr><th scope="row">Destination</th><td id="nav-destination"></td></tr>
            <tr><th scope="row">Distance</th><td id="nav-distance"></td></tr>
            <tr><th scope="row">Total time</th><td id="nav-time"></td></tr>
          </tbody>
        </table>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-danger" data-dismiss="modal" id="nav-complete">Engage</button>
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
      </div>
    </div>
  </div>
</div>
