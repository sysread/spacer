<script type="text/javascript">

$(() => {
  let table = $('#navcomp-table tbody').empty();
  let max_acc = Math.min(game.player.max_acceleration(), game.player.ship_acceleration());

  for (let body of system.bodies().sort()) {
    if (body != game.place().name) {
      let name = system.name(body);
      let plan = system.astrogate(game.place().name, body, max_acc);
      let btn, dist, acc, time, turns, range;

      if (plan !== null) {
        time  = csn(plan.time);
        turns = plan.turns;
        acc   = plan.accel.toFixed(2);
        dist  = plan.au.toFixed(2) || '< 0.01AU';
        range = Math.floor(game.player.ship.range(acc));

        btn = $(`<button data-toggle="modal" data-target="#nav-dialog" type="button" class="btn btn-sm btn-dark btn-block">`);
        btn.append(`<span class="float-left">${name}</span>`);
        btn.append(`<span class="badge badge-pill float-right">${system.kind(body)}</span>`);

        if (turns > range)
          btn.addClass('disabled').removeAttr('data-toggle').removeAttr('data-target').prop('disabled', true);
        else
          btn.data({plan: plan});
      }
      else {
        time  = 'Out of range';
        turns = 'N/A';
        acc   = 'N/A';
        dist  = 'N/A';

        btn = $(`<button type="button" class="btn btn-sm btn-dark btn-block disabled">`);
        btn.append(`<span class="float-left">${name}</span>`);
        btn.append(`<span class="badge badge-pill float-right">${system.kind(body)}</span>`);
      }

      table
        .append($('<tr>')
          .append($('<td>').append(btn))
          .append(`<td class="text-right">${csn(dist)}`)
          .append(`<td class="text-right">${acc}G</td>`)
          .append(`<td class="text-right">${time}</td>`)
          .append(`<td class="text-right">${range * data.hours_per_turn}</td>`));
    }
  }

  $('#nav-dialog').on('show.bs.modal', function(e) {
    let plan   = $(e.relatedTarget).data('plan');
    let target = system.name(plan.dest);
    let type   = system.kind(plan.dest);
    let size   = game.place(plan.dest).size;
    let traits = uniq(game.place(plan.dest).traits, ', ');
    let [days, hours] = plan.days_hours;

    $('#nav-transit').data('plan', plan);

    $('#nav-accel').text(plan.accel.toFixed(1));
    $('#nav-distance-au').text(plan.au.toFixed(1));
    $('#nav-distance-km').text(csn(plan.km.toFixed(0)));
    $('#nav-time').text(`${csn(days)} days, ${csn(hours)} hours (${plan.turns} turns)`);

    let notes = $('<ul>')
      .append(`<li>${type}</li>`)
      .append(`<li>${size} economy</li>`);

    if (traits) notes.append(`<li>${traits}</li>`);

    $('#nav-destination').empty().append(`${target}`).append(notes);

    $('#nav-transit-dest').text(target);
  });

  let transit_intvl;

  let pause_transit = () => {
    window.clearInterval(transit_intvl);
    delete transit_intvl;
  }

  let resume_transit = () => {
    transit_intvl = window.setInterval(() => {
      let plan = $('#nav-transit').data('plan');

      if (plan.left === 0) {
        pause_transit();

        $('#nav-transit-distance').text('0 AU');
        $('#nav-transit-time').text('0 hours');
        $('#nav-transit-progress').css('width', '100%');

        window.setTimeout(() => {
          $('#nav-transit .modal-body').empty();
          $('#nav-transit .modal-header').remove();
          $('#nav-transit .modal-body').html(`<h1>Welcome to <span class="text-capitalize">${plan.dest}</span></h1>`);
          $('#nav-transit .modal-footer').html('<button type="button" class="btn btn-dark" data-dismiss="modal">Disembark</button>');
          $('#nav-transit .modal-body').show();

          $('#spacer-nav').data('in-transit', false);
          game.transit(plan.dest);
        }, 950);
      }
      else {
        let count = Math.min(plan.left, 5);
        for (let i = 0; i < count; ++i) {
          game.player.ship.burn(plan.accel);
          plan.turn();
        }

        let d = plan.dist_left.toFixed(2);
        let p = plan.pct_complete;

        $('#nav-transit-distance').text(`${d} AU`);
        $('#nav-transit-progress').css('width', `${p}%`);

        game.turn(count);
      }
    }, 50);
  }

  $('#nav-transit')
    .on('shown.bs.modal', () => {
      $('#spacer-nav').data('in-transit', true);
      resume_transit();
    })
    .on('hide.bs.modal', () => {
      open('summary');
    });

  $('#nav-player-str').text(game.player.strength);
  $('#nav-player-g'  ).text(game.player.max_acceleration().toFixed(2));
  $('#nav-ship-g'    ).text(game.player.ship_acceleration().toFixed(2));
  $('#nav-ship-t'    ).text(csn(game.player.ship.mass));
});

</script>

<div class="card p-3">
  <h3 class="card-header">Navigation computer</h3>
  <div class="card-body">
    <div class="card-text">
      <p>
        Your navigational computer automatically calculates the optimal
        trajectory from your current location to the other settlements in the
        system.
      </p>
      <p>
        With a strength of <span id="nav-player-str"></span>, you are able to endure a
        sustained <span id="nav-player-g"></span>G burn. Your ship is capable
        of <span id="nav-ship-g"></span>Gs of acceleration with her current
        load out (<span id="nav-ship-t"></span> metric tonnes).
      </p>
      <p>
        For each destination, your ship's range at the required burn rate is
        provided.
      </p>
      <table class="table table-sm" id="navcomp-table">
        <thead>
          <tr>
            <th>Destination</th>
            <th class="text-right">AU</th>
            <th class="text-right">Accel.</th>
            <th class="text-right">Hours</th>
            <th class="text-right">Range</th>
          </tr>
        </thead>
        <tbody>
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="modal" id="nav-dialog" data-backdrop="static">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Flight plan</h5>
      </div>
      <div class="modal-body">
        <p>
          Accelerating at <span id="nav-accel"></span>G, your
          ship will flip at the midway point and begin its deceleration burn.
        </p>
        <table class="table">
          <tbody>
            <tr><th scope="row">Distance (AU)</th><td id="nav-distance-au"></td></tr>
            <tr><th scope="row">Distance (km)</th><td id="nav-distance-km"></td></tr>
            <tr><th scope="row">Total time</th><td id="nav-time"></td></tr>
            <tr><th scope="row">Destination</th><td id="nav-destination"></td></tr>
          </tbody>
        </table>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-dark" data-dismiss="modal" id="nav-complete" data-toggle="modal" data-target="#nav-transit">Engage</button>
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
      </div>
    </div>
  </div>
</div>

<div class="modal" id="nav-transit" data-backdrop="static">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">En route to <span class="text-capitalize" id="nav-transit-dest"></span></h5>
      </div>
      <div class="modal-body">
        <div class="progress bg-dark">
          <div id="nav-transit-progress" class="progress-bar progress-bar-animated bg-warning" style="height: 35px; width: 5%">
            <span id="nav-transit-distance" class="badge badge-pill badge-dark float-left m-1 font-weight-normal" style="font-size:14px"></span>
          </div>
        </div>
      </div>
      <div class="modal-footer">
      </div>
    </div>
  </div>
</div>
