<script type="text/javascript">

$(function() {
  let tradein = game.player.ship.price(true);
  let list = $('#ships');

  $('#ship-detail').on('show.bs.modal', function(e) {
    let ship  = $(e.relatedTarget).data('ship');
    let price = $(e.relatedTarget).data('price');
    let sc    = ship.opt.shipclass;

    let deltav = Math.round(ship.currentAcceleration() * 100) / 100;
    let burn_time = ship.maxBurnTime(deltav, true) * data.hours_per_turn;
    let maxg_range = Physics.AU(Physics.range(burn_time * 3600, 0, deltav));

    let nominal_dv = Math.round(Math.min(0.5, deltav * 0.6) * 100) / 100;
    let nominal_burn_time = ship.maxBurnTime(nominal_dv, true) * data.hours_per_turn;
    let nominal_range = Physics.AU(Physics.range(nominal_burn_time * 3600, 0, 1));

    $('#ship-detail .modal-title').text(sc);
    $('#ship-detail .modal-body').empty();
    $('#ship-detail .modal-body')
      .append(row('Price', csn(price)))
      .append(row(`Range (${Physics.G(deltav).toFixed(2)} G max)`,`${maxg_range.toFixed(2)} AU / ${csn(burn_time)} hr`))
      .append(row(`Range (${Physics.G(nominal_dv).toFixed(2)} G cruise)`, `${nominal_range.toFixed(2)} AU / ${csn(nominal_burn_time)} hr`))
      .append(row('Drive', `${ship.shipclass.drives} ${ship.drive.name}`))
      .append(row('Maximum thrust', `${csn(ship.thrust)} kN`))
      .append(row('Fuel tanks', ship.shipclass.tank))
      .append(row('Hull mass', `${csn(ship.shipclass.mass)} tonnes`))
      .append(row('Drive mass', `${csn(ship.driveMass)} tonnes`))
      .append(row('Total mass (fueled)', `${csn(ship.currentMass())} tonnes`))
      .append(row('Cargo', ship.shipclass.cargo))
      .append(row('Hull', ship.shipclass.hull))
      .append(row('Armor', ship.shipclass.armor))
      .append(row('Hard points', ship.shipclass.hardpoints));

    if (sc === game.player.ship.opt.shipclass || game.player.money < price - tradein) {
      $('#btn-tradein').prop('disabled', true).addClass('disabled');
      $('#tradein').data({});
    }
    else {
      $('#btn-tradein').prop('disabled', false).removeClass('disabled');
      $('#tradein').data($(e.relatedTarget).data());
    }
  });

  $('#tradein').on('show.bs.modal', function(e) {
    let ship  = $('#tradein').data('ship');
    let price = $('#tradein').data('price');
    let cost  = Math.ceil(price - tradein);

    $('#tradein-value').text(csn(tradein));
    $('#new-ship-price').text(csn(price));
    $('#your-ship').text(game.player.ship.opt.shipclass);
    $('#new-ship').text(ship.opt.shipclass);

    if (cost < 0)
      $('#tradein-result').text(`You will make ${csn(-cost)} profit with this deal.`);
    else
      $('#tradein-result').text(`You will pay ${csn(cost)} with this deal.`);

    $(this).data($(e.relatedTarget).data());
  });

  $('#tradein-complete').on('click', (e) => {
    let ship  = $('#tradein').data('ship');
    let price = $('#tradein').data('price');
    game.player.money += tradein;
    game.player.money -= price;
    game.player.ship = ship;
    game.turn();
    game.save_game();
  });

  for (let sc of Object.keys(data.shipclass)) {
    let info = data.shipclass[sc];
    let faction_adjustment = 1.0;

    if (info.restricted && game.player.faction !== game.place().faction)
      return;

    if (info.hasOwnProperty('faction')) {
      if (info.faction !== game.place().faction) return;
      if (info.faction !== game.player.faction) return;
      faction_adjustment = 0.8;
    }

    let ship = new Ship({shipclass: sc, fuel: info.tank});
    let price = ship.price();
    price += price * game.place().sales_tax;
    price *= faction_adjustment;
    price = Math.ceil(price);

    let name = $(`<h5 class="text-capitalize">${sc}</h5>`);
    let btn  = $(`<button type="button" class="btn btn-dark float-right" data-toggle="modal" data-target="#ship-detail">Info</button>`);
    btn.data({ship: ship, price: price});

    list.append(row(name.append(btn), `${csn(price)}`));
  }
});

</script>

<div class="card">
  <h3 class="card-header">Ships</h3>
  <div class="card-body">
    <div id="ships" class="card-text">
    </div>
  </div>
</div>

<div class="modal" id="ship-detail">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title text-capitalize"></h5>
        <button type="button" id="btn-tradein" class="btn btn-dark float-right" data-dismiss="modal" data-toggle="modal" data-target="#tradein">Trade in</button>
      </div>
      <div class="modal-body"></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<div class="modal" id="tradein">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Purchase ship</h5>
      </div>
      <div class="modal-body">
        <p>You will receive <span id="tradein-value"></span> credits for trading in your ship.</p>
        <p>You will pay <span id="new-ship-price"></span> credits for a shiny, new <span id="new-ship"></span>.</p>
        <p id="tradein-result"></p>
        <p>Do you wish to complete this exchange?</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-dark" data-dismiss="modal" id="tradein-complete">Trade in</button>
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
      </div>
    </div>
  </div>
</div>
